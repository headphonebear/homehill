# mk3 - Music Server
# presented by Ana ðŸ¦Š

version: '3.8'

services:
  # Traefik - Reverse Proxy (Internal with Self-Signed Certs)
  traefik:
    image: traefik:v2.11  # v2.11 for better Docker API compatibility
    container_name: mk3-traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.mk3.homehill.de`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH}"
    networks:
      - mk3-net

  # Jellyfin - Media Streaming
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: mk3-jellyfin
    restart: unless-stopped
    user: "2001:2001"  # mk3 user
    environment:
      - TZ=${TZ:-Europe/Berlin}
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - /srv/music/mk3:/music/mk3:ro
      - /srv/music/io1:/music/io1:ro
      - /srv/music/cl1:/music/cl1:ro
      - /srv/music/sg1:/music/sg1:ro
    ports:
      - "8096:8096"  # Direct access for mobile apps
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.mk3.homehill.de`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    networks:
      - mk3-net
    depends_on:
      - traefik

  # Navidrome - Subsonic API
  navidrome:
    image: deluan/navidrome:latest
    container_name: mk3-navidrome
    restart: unless-stopped
    user: "2001:2001"  # mk3 user
    environment:
      - ND_MUSICFOLDER=/music
      - ND_DATAFOLDER=/data
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_BASEURL=https://navidrome.mk3.homehill.de
      - ND_ENABLETRANSCODINGCONFIG=true
    volumes:
      - navidrome-data:/data
      - /srv/music/mk3:/music/mk3:ro
      - /srv/music/io1:/music/io1:ro
      - /srv/music/cl1:/music/cl1:ro
      - /srv/music/sg1:/music/sg1:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.rule=Host(`navidrome.mk3.homehill.de`)"
      - "traefik.http.routers.navidrome.entrypoints=websecure"
      - "traefik.http.routers.navidrome.tls=true"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
    networks:
      - mk3-net
    depends_on:
      - traefik

  # DragonflyDB - High-Performance In-Memory Cache
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: mk3-dragonfly
    restart: unless-stopped
    command:
      - --maxmemory=2gb
      - --snapshot_cron=0 * * * *  # Hourly snapshots at :00
      - --dir=/data
    volumes:
      - dragonfly-data:/data
    networks:
      - mk3-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL - Music Metadata Database
  postgres:
    image: postgres:16-alpine
    container_name: mk3-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-mk3}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mk3-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  traefik-certs:
  jellyfin-config:
  jellyfin-cache:
  navidrome-data:
  postgres-data:
  dragonfly-data:

networks:
  mk3-net:
    name: mk3-network
    driver: bridge
