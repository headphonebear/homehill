# mk3 - Music Server
# presented by Ana ðŸ¦Š

version: '3.8'

services:
  # Jellyfin - Media Streaming
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: mk3-jellyfin
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Berlin}
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - /srv/music:/music:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.mk3.homehill.de`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    networks:
      - mk3-net

  # Navidrome - Subsonic API
  navidrome:
    image: deluan/navidrome:latest
    container_name: mk3-navidrome
    restart: unless-stopped
    environment:
      - ND_MUSICFOLDER=/music/flac
      - ND_DATAFOLDER=/data
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_BASEURL=https://navidrome.mk3.homehill.de
    volumes:
      - navidrome-data:/data
      - /srv/music:/music:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.rule=Host(`navidrome.mk3.homehill.de`)"
      - "traefik.http.routers.navidrome.entrypoints=websecure"
      - "traefik.http.routers.navidrome.tls.certresolver=letsencrypt"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
    networks:
      - mk3-net

  # PostgreSQL - Music Metadata Database
  postgres:
    image: postgres:16-alpine
    container_name: mk3-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-mk3}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mk3-net

  # Redis - Caching & Queues
  redis:
    image: redis:7-alpine
    container_name: mk3-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - mk3-net

volumes:
  jellyfin-config:
  jellyfin-cache:
  navidrome-data:
  postgres-data:
  redis-data:

networks:
  mk3-net:
    name: mk3-network
    driver: bridge
